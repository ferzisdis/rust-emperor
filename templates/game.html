{% extends "base.html" %}

{% block title %}{{ state.user_name }} - {{ state.get_grade_title() }} - Year {{ state.year }}{% endblock %}

{% block content %}
<div class="game-view">
    <!-- Combined Header with Resources -->
    <div class="game-header-combined">
        <div class="player-info-inline">
            <span class="player-title">{{ state.get_grade_title() }} {{ state.user_name }}</span>
            <span class="player-meta">(Year {{ state.year }} / Round {{ state.round }})</span>
        </div>
        <div class="resources-inline">
            <div class="resource-inline">
                <span class="resource-icon">ğŸ’°</span>
                <span class="resource-label">Gold</span>
                <span class="resource-value">{{ state.gold }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon">ğŸŒ¾</span>
                <span class="resource-label">Food</span>
                <span class="resource-value">{{ state.food_quantity }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon">ğŸ‘¥</span>
                <span class="resource-label">Citizen</span>
                <span class="resource-value">{{ state.man_quantity }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon">âš”ï¸</span>
                <span class="resource-label">Army</span>
                <span class="resource-value">{{ state.soldier_quantity }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon">â¤ï¸</span>
                <span class="resource-label">Popularity</span>
                <span class="resource-value">{{ state.popularity_percent }}%</span>
            </div>
        </div>
    </div>

    <!-- Main Game Area -->
    <div class="game-content">
        <!-- Kingdom Visual Representation -->
        <div class="kingdom-section">
            <h3 class="title-decorative">ğŸ° Your Kingdom</h3>
            <div class="kingdom-canvas">
                <!-- Background Land -->
                <img src="/static/images/deg_land.png" alt="Land" class="kingdom-land pixel-art" />

                <!-- Castle Structures - positioned based on level -->
                {% if state.castle_level == 0 %}
                <img src="/static/images/deg_castle0.png" alt="Castle Level 0" class="kingdom-castle castle-main pixel-art" />
                {% endif %}
                {% if state.castle_level > 0 %}
                {% if state.castle_level < 5 %}
                <img src="/static/images/deg_castle1.png" alt="Castle Level 1-4" class="kingdom-castle castle-main pixel-art" />
                {% endif %}
                {% endif %}
                {% if state.castle_level > 1 %}
                <img src="/static/images/deg_castle2.png" alt="Castle Tower 1" class="kingdom-castle castle-left-tower pixel-art" />
                {% endif %}
                {% if state.castle_level > 2 %}
                <img src="/static/images/deg_castle3.png" alt="Castle Wing" class="kingdom-castle castle-left-wing pixel-art" />
                {% endif %}
                {% if state.castle_level > 3 %}
                <img src="/static/images/deg_castle4.png" alt="Castle Level 4+" class="kingdom-castle castle-main-upgrade pixel-art" />
                {% endif %}
                {% if state.castle_level > 4 %}
                <img src="/static/images/deg_castle3.png" alt="Castle Right Wing" class="kingdom-castle castle-right-wing pixel-art" />
                {% endif %}
                {% if state.castle_level > 5 %}
                <img src="/static/images/deg_castle2.png" alt="Castle Right Tower" class="kingdom-castle castle-right-tower pixel-art" />
                {% endif %}
                {% if state.castle_level > 6 %}
                <img src="/static/images/deg_castle5.png" alt="Castle Spire Left" class="kingdom-castle castle-spire-left pixel-art" />
                {% endif %}
                {% if state.castle_level > 7 %}
                <img src="/static/images/deg_castle5.png" alt="Castle Spire Right" class="kingdom-castle castle-spire-right pixel-art" />
                {% endif %}

                <!-- Farms - positioned based on quantity -->
                {% if state.farm_quantity > 0 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-1 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 19 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-2 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 29 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-3 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 39 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-4 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 49 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-5 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 99 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-6 pixel-art" />
                {% endif %}

                <!-- Markets - positioned based on quantity -->
                {% if state.market_quantity > 0 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-1 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 4 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-2 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 9 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-3 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 39 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-4 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 49 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-5 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 99 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-6 pixel-art" />
                {% endif %}

                <!-- Mines - positioned based on quantity -->
                {% if state.mine_quantity > 0 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-1 pixel-art" />
                {% endif %}
                {% if state.mine_quantity > 19 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-2 pixel-art" />
                {% endif %}
                {% if state.mine_quantity > 29 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-3 pixel-art" />
                {% endif %}

                <!-- Smithies - positioned based on quantity -->
                {% if state.smithy_quantity > 0 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-1 pixel-art" />
                {% endif %}
                {% if state.smithy_quantity > 19 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-2 pixel-art" />
                {% endif %}
                {% if state.smithy_quantity > 29 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-3 pixel-art" />
                {% endif %}
            </div>

        </div>

        <!-- Action Panels -->
        <div class="action-panels">
            <!-- Settings Panel -->
            <div class="panel">
                <h3>âš™ï¸ Settings</h3>
                <div class="setting-item">
                    <label>Taxes:</label>
                    <select name="taxes_level" hx-post="/game/set-taxes" hx-target="body" hx-swap="innerHTML" class="setting-select">
                        <option value="0" {% if state.taxes_level == 0 %}selected{% endif %}>None</option>
                        <option value="1" {% if state.taxes_level == 1 %}selected{% endif %}>Very Low</option>
                        <option value="2" {% if state.taxes_level == 2 %}selected{% endif %}>Low</option>
                        <option value="3" {% if state.taxes_level == 3 %}selected{% endif %}>Medium</option>
                        <option value="4" {% if state.taxes_level == 4 %}selected{% endif %}>High</option>
                        <option value="5" {% if state.taxes_level == 5 %}selected{% endif %}>Very High</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Food Rations:</label>
                    <select name="food_supply" hx-post="/game/set-food-supply" hx-target="body" hx-swap="innerHTML" class="setting-select">
                        <option value="0" {% if state.food_supply == 0 %}selected{% endif %}>None</option>
                        <option value="1" {% if state.food_supply == 1 %}selected{% endif %}>Very Low</option>
                        <option value="2" {% if state.food_supply == 2 %}selected{% endif %}>Low</option>
                        <option value="3" {% if state.food_supply == 3 %}selected{% endif %}>Medium</option>
                        <option value="4" {% if state.food_supply == 4 %}selected{% endif %}>High</option>
                        <option value="5" {% if state.food_supply == 5 %}selected{% endif %}>Very High</option>
                    </select>
                </div>
            </div>

            <!-- Buildings Panel -->
            <div class="panel">
                <h3>ğŸ—ï¸ Buildings</h3>
                <div class="building-list">
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon">ğŸ°</span>
                            <span>Castle: Level {{ state.castle_level }}</span>
                        </span>
                        {% if state.castle_level < 8 %}
                        <button hx-post="/game/upgrade-castle" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_upgrade_castle() %}disabled{% endif %}>
                            Upgrade ({{ state.price_for_castle }} ğŸ’°)
                        </button>
                        {% else %}
                        <button class="btn btn-small" disabled>Max Level</button>
                        {% endif %}
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon">ğŸŒ¾</span>
                            <span>Farms: {{ state.farm_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-farm" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_farm() %}disabled{% endif %}>
                            Build ({{ state.price_for_farm }} ğŸ’°)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon">â›ï¸</span>
                            <span>Mines: {{ state.mine_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-mine" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_mine() %}disabled{% endif %}>
                            Build ({{ state.price_for_mine }} ğŸ’°)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon">ğŸ”¨</span>
                            <span>Smithies: {{ state.smithy_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-smithy" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_smithy() %}disabled{% endif %}>
                            Build ({{ state.price_for_smithy }} ğŸ’°)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon">ğŸª</span>
                            <span>Markets: {{ state.market_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-market" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_market() %}disabled{% endif %}>
                            Build ({{ state.price_for_market }} ğŸ’°)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Military Panel -->
            <div class="panel">
                <h3>âš”ï¸ Military</h3>
                
                <!-- Military Stats -->
                <div class="military-info" style="margin-bottom: 12px;">
                    <p style="margin: 4px 0;">âš”ï¸ Soldiers: <strong></strong>{{ state.soldier_quantity }}</strong></p>
                    <p style="margin: 4px 0;">ğŸ—¡ï¸ Weapons: <strong></strong>{{ state.weapon_quantity }}</strong></p>
                    <p style="margin: 4px 0;">â›ï¸ Iron: <strong>{{ state.iron_quantity }}</strong></p>
                </div>

                <!-- Recruitment Info -->
                <div style="background: rgba(0,0,0,0.05); padding: 8px; border-radius: 4px; margin-bottom: 12px; font-size: 0.85em;">
                    <p style="margin: 3px 0;"><strong>Cost per soldier:</strong> {{ state.soldier_price }} ğŸ’°</p>
                    <p style="margin: 3px 0;"><strong>Requirements:</strong> 1 weapon, 1 citizen</p>
                    <p style="margin: 3px 0; color: #c0392b;"><strong>Min citizens:</strong> 200 must remain</p>
                </div>

                <!-- Recruitment Limits -->
                <div style="font-size: 0.85em; margin-bottom: 12px; padding: 6px; background: rgba(52, 152, 219, 0.1); border-radius: 4px;">
                    <p style="margin: 2px 0; font-weight: bold; color: #2980b9;">Max recruitable:</p>
                    <p style="margin: 2px 0;">By gold: {{ state.max_recruitable_by_gold() }}</p>
                    <p style="margin: 2px 0;">By weapons: {{ state.weapon_quantity }}</p>
                    <p style="margin: 2px 0;">By citizens: {{ state.max_recruitable_by_citizens() }}</p>
                </div>

                <!-- Recruit Soldiers Form -->
                <form hx-post="/game/army/recruit" hx-target="body" hx-swap="innerHTML" style="margin-bottom: 10px;">
                    <div style="margin-bottom: 8px;">
                        <label for="recruit_quantity" style="display: block; margin-bottom: 4px; font-size: 0.9em; font-weight: bold;">Recruit Soldiers:</label>
                        <input
                            type="number"
                            id="recruit_quantity"
                            name="quantity"
                            min="1"
                            max="1000"
                            value="1"
                            style="width: 100%; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9em;"
                            required
                        />
                    </div>
                    <div style="display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap;">
                        <button type="button" onclick="document.getElementById('recruit_quantity').value='1'" style="flex: 1; padding: 4px; font-size: 0.8em; background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 3px; cursor: pointer;">1</button>
                        <button type="button" onclick="document.getElementById('recruit_quantity').value='10'" style="flex: 1; padding: 4px; font-size: 0.8em; background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 3px; cursor: pointer;">10</button>
                        <button type="button" onclick="document.getElementById('recruit_quantity').value='50'" style="flex: 1; padding: 4px; font-size: 0.8em; background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 3px; cursor: pointer;">50</button>
                        <button type="button" onclick="document.getElementById('recruit_quantity').value='100'" style="flex: 1; padding: 4px; font-size: 0.8em; background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 3px; cursor: pointer;">100</button>
                    </div>
                    <button
                        type="submit"
                        class="btn btn-small"
                        style="width: 100%;"
                        {% if state.man_quantity <= 200 || state.weapon_quantity == 0 || !state.can_afford_soldier() %}disabled{% endif %}>
                        ğŸ–ï¸ Recruit Soldiers
                    </button>
                </form>

                <!-- Discharge Soldiers Form -->
                <form hx-post="/game/army/discharge" hx-target="body" hx-swap="innerHTML">
                    <div style="margin-bottom: 8px;">
                        <label for="discharge_quantity" style="display: block; margin-bottom: 4px; font-size: 0.9em; font-weight: bold;">Discharge Soldiers:</label>
                        <input
                            type="number"
                            id="discharge_quantity"
                            name="quantity"
                            min="1"
                            max="{{ state.soldier_quantity }}"
                            value="1"
                            style="width: 100%; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 0.9em;"
                            required
                        />
                    </div>
                    <div style="display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap;">
                        <button type="button" onclick="document.getElementById('discharge_quantity').value='1'" style="flex: 1; padding: 4px; font-size: 0.8em; background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 3px; cursor: pointer;">1</button>
                        <button type="button" onclick="document.getElementById('discharge_quantity').value='10'" style="flex: 1; padding: 4px; font-size: 0.8em; background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 3px; cursor: pointer;">10</button>
                        <button type="button" onclick="document.getElementById('discharge_quantity').value='50'" style="flex: 1; padding: 4px; font-size: 0.8em; background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 3px; cursor: pointer;">50</button>
                        <button type="button" onclick="document.getElementById('discharge_quantity').value='{{ state.soldier_quantity }}'" style="flex: 1; padding: 4px; font-size: 0.8em; background: #ecf0f1; border: 1px solid #bdc3c7; border-radius: 3px; cursor: pointer;">All</button>
                    </div>
                    <button
                        type="submit"
                        class="btn btn-small"
                        style="width: 100%; background: #95a5a6;"
                        {% if state.soldier_quantity == 0 %}disabled{% endif %}>
                        ğŸ  Discharge (Get {{ state.soldier_price }} ğŸ’° back)
                    </button>
                </form>

                <!-- Help Tip -->
                <div style="margin-top: 12px; padding: 8px; background: rgba(241, 196, 15, 0.1); border-left: 3px solid #f39c12; font-size: 0.8em;">
                    <p style="margin: 0;"><strong>ğŸ’¡ Tip:</strong> Soldiers are required for rank advancement. Weapons come from smithies using iron from mines.</p>
                </div>
            </div>

            <!-- Trade Panel -->
            <div class="panel">
                <h3>ğŸ’± Trade</h3>
                {% if state.market_quantity == 0 %}
                <p class="hint">Build a market to trade!</p>
                {% else %}
                <div class="trade-divider">
                    <p style="font-size: 0.9em;">Markets: {{ state.market_quantity }}</p>
                </div>

                <!-- Food Trading -->
                <div class="trade-inline-section">
                    <h4>ğŸŒ¾ Food ({{ state.price_for_food }}ğŸ’°/100)</h4>
                    <div class="trade-controls">
                        <select name="quantity" id="trade_food_qty" class="setting-select">
                            <option value="100">100</option>
                            <option value="1000">1,000</option>
                            <option value="10000">10,000</option>
                        </select>
                        <button hx-post="/game/trade/buy-food" hx-vals='js:{quantity: document.getElementById("trade_food_qty").value}' hx-target="body" hx-swap="innerHTML" class="btn btn-small">Buy</button>
                        <button hx-post="/game/trade/sell-food" hx-vals='js:{quantity: document.getElementById("trade_food_qty").value}' hx-target="body" hx-swap="innerHTML" class="btn btn-small">Sell</button>
                    </div>
                </div>

                <!-- Iron Trading -->
                {% if state.market_quantity > 4 %}
                <div class="trade-inline-section">
                    <h4>âš™ï¸ Iron ({{ state.price_for_armor }}ğŸ’°/unit)</h4>
                    <div class="trade-controls">
                        <select name="quantity" id="trade_iron_qty" class="setting-select">
                            <option value="1">1</option>
                            <option value="10">10</option>
                            <option value="100">100</option>
                        </select>
                        <button hx-post="/game/trade/buy-iron" hx-vals='js:{quantity: document.getElementById("trade_iron_qty").value}' hx-target="body" hx-swap="innerHTML" class="btn btn-small">Buy</button>
                    </div>
                </div>
                {% else %}
                <div class="trade-inline-section trade-locked">
                    <h4>ğŸ”’ Iron</h4>
                    <p class="hint">Need 5+ markets</p>
                </div>
                {% endif %}

                <!-- Weapons Trading -->
                {% if state.market_quantity > 9 %}
                <div class="trade-inline-section">
                    <h4>âš”ï¸ Weapons ({{ state.price_for_weapon }}ğŸ’°/unit)</h4>
                    <div class="trade-controls">
                        <select name="quantity" id="trade_weapon_qty" class="setting-select">
                            <option value="1">1</option>
                            <option value="10">10</option>
                            <option value="100">100</option>
                        </select>
                        <button hx-post="/game/trade/buy-weapons" hx-vals='js:{quantity: document.getElementById("trade_weapon_qty").value}' hx-target="body" hx-swap="innerHTML" class="btn btn-small">Buy</button>
                    </div>
                </div>
                {% else %}
                <div class="trade-inline-section trade-locked">
                    <h4>ğŸ”’ Weapons</h4>
                    <p class="hint">Need 10+ markets</p>
                </div>
                {% endif %}
                {% endif %}
            </div>

        </div>

        <!-- Advancement Requirements -->
        <div class="advancement-panel">
            <h3>ğŸ“Š Advancement to {{ state.get_next_grade_title() }}</h3>
            {% if state.grade < 5 %}
            <div class="requirements-list">
                {% for req in state.get_grade_requirements() %}
                {% if req.2 > req.1 %}
                <div class="requirement-item">
                    <span class="req-name">{{ req.0 }}</span>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <p class="max-rank">You have achieved the highest rank!</p>
            {% endif %}
        </div>
    </div>

    <!-- Fixed Footer with Finish Round Button -->
    <div class="game-footer-fixed">
        <button hx-post="/game/finish-round" hx-target="body" hx-swap="innerHTML" class="btn btn-large btn-finish-round">
            â­ï¸ Finish Round &amp; Continue
        </button>
    </div>
</div>
{% endblock %}