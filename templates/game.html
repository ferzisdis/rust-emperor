{% extends "base.html" %}

{% block title %}{{ state.user_name }} - {{ state.get_grade_title() }} - Year {{ state.year }}{% endblock %}

{% block content %}
<div class="game-view">
    <!-- Combined Header with Resources -->
    <div class="game-header-combined">
        <div class="player-info-inline">
            <span class="player-title">{{ state.get_grade_title() }} {{ state.user_name }}</span>
            <span class="player-meta">(Year {{ state.year }} / Round {{ state.round }})</span>
        </div>
        <div class="resources-inline">
            <div class="resource-inline">
                <span class="resource-icon"><img src="/static/images/deg_gold.png" alt="Gold" style="height: 1em; vertical-align: middle;"></span>
                <span class="resource-label">Gold</span>
                <span class="resource-value">{{ state.gold }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon"><img src="/static/images/deg_food.png" alt="Food" style="height: 1em; vertical-align: middle;"></span>
                <span class="resource-label">Food</span>
                <span class="resource-value">{{ state.food_quantity }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon"><img src="/static/images/deg_man.png" alt="Citizens" style="height: 1em; vertical-align: middle;"></span>
                <span class="resource-label">Citizen</span>
                <span class="resource-value">{{ state.man_quantity }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon"><img src="/static/images/deg_soldier.png" alt="Army" style="height: 1em; vertical-align: middle;"></span>
                <span class="resource-label">Army</span>
                <span class="resource-value">{{ state.soldier_quantity }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon">♥</span>
                <span class="resource-label">Popularity</span>
                <span class="resource-value">{{ state.popularity_percent }}%</span>
            </div>
        </div>
    </div>

    <!-- Main Game Area -->
    <div class="game-content">
        <!-- Kingdom Visual Representation -->
        <div class="kingdom-section">
            <h3 class="title-decorative"><img src="/static/images/deg_castle1.png" alt="Castle" style="height: 1em; vertical-align: middle;"> Your Kingdom</h3>
            <div class="kingdom-canvas">
                <!-- Background Land -->
                <img src="/static/images/deg_land.png" alt="Land" class="kingdom-land pixel-art" />

                <!-- Castle Structures - positioned based on level -->
                {% if state.castle_level == 0 %}
                <img src="/static/images/deg_castle0.png" alt="Castle Level 0" class="kingdom-castle castle-main pixel-art" />
                {% endif %}
                {% if state.castle_level > 0 %}
                {% if state.castle_level < 5 %}
                <img src="/static/images/deg_castle1.png" alt="Castle Level 1-4" class="kingdom-castle castle-main pixel-art" />
                {% endif %}
                {% endif %}
                {% if state.castle_level > 1 %}
                <img src="/static/images/deg_castle2.png" alt="Castle Tower 1" class="kingdom-castle castle-left-tower pixel-art" />
                {% endif %}
                {% if state.castle_level > 2 %}
                <img src="/static/images/deg_castle3.png" alt="Castle Wing" class="kingdom-castle castle-left-wing pixel-art" />
                {% endif %}
                {% if state.castle_level > 3 %}
                <img src="/static/images/deg_castle4.png" alt="Castle Level 4+" class="kingdom-castle castle-main-upgrade pixel-art" />
                {% endif %}
                {% if state.castle_level > 4 %}
                <img src="/static/images/deg_castle3.png" alt="Castle Right Wing" class="kingdom-castle castle-right-wing pixel-art" />
                {% endif %}
                {% if state.castle_level > 5 %}
                <img src="/static/images/deg_castle2.png" alt="Castle Right Tower" class="kingdom-castle castle-right-tower pixel-art" />
                {% endif %}
                {% if state.castle_level > 6 %}
                <img src="/static/images/deg_castle5.png" alt="Castle Spire Left" class="kingdom-castle castle-spire-left pixel-art" />
                {% endif %}
                {% if state.castle_level > 7 %}
                <img src="/static/images/deg_castle5.png" alt="Castle Spire Right" class="kingdom-castle castle-spire-right pixel-art" />
                {% endif %}

                <!-- Farms - positioned based on quantity -->
                {% if state.farm_quantity > 0 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-1 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 19 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-2 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 29 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-3 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 39 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-4 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 49 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-5 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 99 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-6 pixel-art" />
                {% endif %}

                <!-- Markets - positioned based on quantity -->
                {% if state.market_quantity > 0 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-1 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 4 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-2 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 9 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-3 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 39 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-4 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 49 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-5 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 99 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-6 pixel-art" />
                {% endif %}

                <!-- Mines - positioned based on quantity -->
                {% if state.mine_quantity > 0 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-1 pixel-art" />
                {% endif %}
                {% if state.mine_quantity > 19 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-2 pixel-art" />
                {% endif %}
                {% if state.mine_quantity > 29 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-3 pixel-art" />
                {% endif %}

                <!-- Smithies - positioned based on quantity -->
                {% if state.smithy_quantity > 0 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-1 pixel-art" />
                {% endif %}
                {% if state.smithy_quantity > 19 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-2 pixel-art" />
                {% endif %}
                {% if state.smithy_quantity > 29 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-3 pixel-art" />
                {% endif %}
            </div>

        </div>

        <!-- Action Panels -->
        <div class="action-panels">
            <!-- Settings Panel -->
            <div class="panel">
                <h3>⚙️ Settings</h3>
                <div class="setting-item">
                    <label>Taxes:</label>
                    <select name="taxes_level" hx-post="/game/set-taxes" hx-target="body" hx-swap="innerHTML" class="setting-select">
                        <option value="0" {% if state.taxes_level == 0 %}selected{% endif %}>None (0 gold)</option>
                        <option value="1" {% if state.taxes_level == 1 %}selected{% endif %}>Very Low ({{ (state.man_quantity * 1 * 10 / 30) }} gold)</option>
                        <option value="2" {% if state.taxes_level == 2 %}selected{% endif %}>Low ({{ (state.man_quantity * 2 * 10 / 30) }} gold)</option>
                        <option value="3" {% if state.taxes_level == 3 %}selected{% endif %}>Medium ({{ (state.man_quantity * 3 * 10 / 30) }} gold)</option>
                        <option value="4" {% if state.taxes_level == 4 %}selected{% endif %}>High ({{ (state.man_quantity * 4 * 10 / 30) }} gold)</option>
                        <option value="5" {% if state.taxes_level == 5 %}selected{% endif %}>Very High ({{ (state.man_quantity * 5 * 10 / 30) }} gold)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Food Rations:</label>
                    <select name="food_supply" hx-post="/game/set-food-supply" hx-target="body" hx-swap="innerHTML" class="setting-select">
                        <option value="0" {% if state.food_supply == 0 %}selected{% endif %}>None (0 food)</option>
                        <option value="1" {% if state.food_supply == 1 %}selected{% endif %}>Very Low ({{ (state.man_quantity * (1 * 34 - 2) / 100) }} food)</option>
                        <option value="2" {% if state.food_supply == 2 %}selected{% endif %}>Low ({{ (state.man_quantity * (2 * 34 - 2) / 100) }} food)</option>
                        <option value="3" {% if state.food_supply == 3 %}selected{% endif %}>Medium ({{ (state.man_quantity * (3 * 34 - 2) / 100) }} food)</option>
                        <option value="4" {% if state.food_supply == 4 %}selected{% endif %}>High ({{ (state.man_quantity * (4 * 34 - 2) / 100) }} food)</option>
                        <option value="5" {% if state.food_supply == 5 %}selected{% endif %}>Very High ({{ (state.man_quantity * (5 * 34 - 2) / 100) }} food)</option>
                    </select>
                </div>
            </div>

            <!-- Buildings Panel -->
            <div class="panel">
                <h3><img src="/static/images/deg_castle1.png" alt="Buildings" style="height: 1em; vertical-align: middle;"> Buildings</h3>
                <div class="building-list">
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon"><img src="/static/images/deg_castle1.png" alt="Castle" style="height: 1em; vertical-align: middle;"></span>
                            <span>Castle: Level {{ state.castle_level }}</span>
                        </span>
                        {% if state.castle_level < 8 %}
                        <button hx-post="/game/upgrade-castle" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_upgrade_castle() %}disabled{% endif %}>
                            Upgrade ({{ state.price_for_castle }} <img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">)
                        </button>
                        {% else %}
                        <button class="btn btn-small" disabled>Max Level</button>
                        {% endif %}
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon"><img src="/static/images/deg_farm.png" alt="Farm" style="height: 1em; vertical-align: middle;"></span>
                            <span>Farms: {{ state.farm_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-farm" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_farm() %}disabled{% endif %}>
                            Build ({{ state.price_for_farm }} <img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon"><img src="/static/images/deg_mine.png" alt="Mine" style="height: 1em; vertical-align: middle;"></span>
                            <span>Mines: {{ state.mine_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-mine" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_mine() %}disabled{% endif %}>
                            Build ({{ state.price_for_mine }} <img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon"><img src="/static/images/deg_smithy.png" alt="Smithy" style="height: 1em; vertical-align: middle;"></span>
                            <span>Smithies: {{ state.smithy_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-smithy" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_smithy() %}disabled{% endif %}>
                            Build ({{ state.price_for_smithy }} <img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon"><img src="/static/images/deg_market.png" alt="Market" style="height: 1em; vertical-align: middle;"></span>
                            <span>Markets: {{ state.market_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-market" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_market() %}disabled{% endif %}>
                            Build ({{ state.price_for_market }} <img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Military Panel -->
            <div class="panel">
                <h3><img src="/static/images/deg_soldier.png" alt="Military" style="height: 1em; vertical-align: middle;"> Military</h3>

                <div class="trade-divider">
                    <p style="font-size: 0.9em;">Soldiers: {{ state.soldier_quantity }} | Weapons: {{ state.weapon_quantity }}</p>
                    <p class="hint" style="font-size: 0.85em; margin-top: 4px;">Cost: {{ state.soldier_price }} <img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;"> | Need: 1 weapon + 1 citizen</p>
                </div>

                <!-- Recruit Soldiers -->
                <div class="trade-inline-section">
                    <h4><img src="/static/images/deg_soldier.png" alt="Recruit" style="height: 1em; vertical-align: middle;"> Recruit Soldiers</h4>
                    <div class="trade-controls">
                        <select name="quantity" id="recruit_qty" class="setting-select">
                            <option value="1">1</option>
                            <option value="10">10</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <button 
                            hx-post="/game/army/recruit" 
                            hx-vals='js:{quantity: document.getElementById("recruit_qty").value}' 
                            hx-target="body" 
                            hx-swap="innerHTML" 
                            class="btn btn-small"
                            {% if state.man_quantity <= 200 || state.weapon_quantity == 0 || !state.can_afford_soldier() %}disabled{% endif %}>
                            Recruit
                        </button>
                    </div>
                </div>

                <!-- Discharge Soldiers -->
                <div class="trade-inline-section">
                    <h4><img src="/static/images/deg_man.png" alt="Discharge" style="height: 1em; vertical-align: middle;"> Discharge Soldiers</h4>
                    <div class="trade-controls">
                        <select name="quantity" id="discharge_qty" class="setting-select">
                            <option value="1">1</option>
                            <option value="10">10</option>
                            <option value="50">50</option>
                            <option value="{{ state.soldier_quantity }}">All ({{ state.soldier_quantity }})</option>
                        </select>
                        <button 
                            hx-post="/game/army/discharge" 
                            hx-vals='js:{quantity: document.getElementById("discharge_qty").value}' 
                            hx-target="body" 
                            hx-swap="innerHTML" 
                            class="btn btn-small"
                            {% if state.soldier_quantity == 0 %}disabled{% endif %}>
                            Discharge
                        </button>
                    </div>
                </div>
            </div>

            <!-- Trade Panel -->
            <div class="panel">
                <h3><img src="/static/images/deg_market.png" alt="Trade" style="height: 1em; vertical-align: middle;"> Trade</h3>
                {% if state.market_quantity == 0 %}
                <p class="hint">Build a market to trade!</p>
                {% else %}
                <div class="trade-divider">
                    <p style="font-size: 0.9em;">Markets: {{ state.market_quantity }}</p>
                </div>

                <!-- Food Trading -->
                <div class="trade-inline-section">
                    <h4><img src="/static/images/deg_food.png" alt="Food" style="height: 1em; vertical-align: middle;"> Food ({{ state.price_for_food }}<img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">/100)</h4>
                    <div class="trade-controls">
                        <select name="quantity" id="trade_food_qty" class="setting-select">
                            <option value="100">100</option>
                            <option value="1000">1,000</option>
                            <option value="10000">10,000</option>
                        </select>
                        <button hx-post="/game/trade/buy-food" hx-vals='js:{quantity: document.getElementById("trade_food_qty").value}' hx-target="body" hx-swap="innerHTML" class="btn btn-small">Buy</button>
                        <button hx-post="/game/trade/sell-food" hx-vals='js:{quantity: document.getElementById("trade_food_qty").value}' hx-target="body" hx-swap="innerHTML" class="btn btn-small">Sell</button>
                    </div>
                </div>

                <!-- Iron Trading -->
                {% if state.market_quantity > 4 %}
                <div class="trade-inline-section">
                    <h4><img src="/static/images/deg_iron.png" alt="Iron" style="height: 1em; vertical-align: middle;"> Iron ({{ state.price_for_armor }}<img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">/unit)</h4>
                    <div class="trade-controls">
                        <select name="quantity" id="trade_iron_qty" class="setting-select">
                            <option value="1">1</option>
                            <option value="10">10</option>
                            <option value="100">100</option>
                        </select>
                        <button hx-post="/game/trade/buy-iron" hx-vals='js:{quantity: document.getElementById("trade_iron_qty").value}' hx-target="body" hx-swap="innerHTML" class="btn btn-small">Buy</button>
                        <button hx-post="/game/trade/sell-iron" hx-vals='js:{quantity: document.getElementById("trade_iron_qty").value}' hx-target="body" hx-swap="innerHTML" class="btn btn-small">Sell</button>
                    </div>
                </div>
                {% else %}
                <div class="trade-inline-section trade-locked">
                    <h4><img src="/static/images/deg_iron.png" alt="Iron" style="height: 1em; vertical-align: middle;"> Iron</h4>
                    <p class="hint">Need 5+ markets</p>
                </div>
                {% endif %}

                <!-- Weapons Trading -->
                {% if state.market_quantity > 9 %}
                <div class="trade-inline-section">
                    <h4><img src="/static/images/deg_weapons.png" alt="Weapons" style="height: 1em; vertical-align: middle;"> Weapons ({{ state.price_for_weapon }}<img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">/unit)</h4>
                    <div class="trade-controls">
                        <select name="quantity" id="trade_weapon_qty" class="setting-select">
                            <option value="1">1</option>
                            <option value="10">10</option>
                            <option value="100">100</option>
                        </select>
                        <button hx-post="/game/trade/buy-weapons" hx-vals='js:{quantity: document.getElementById("trade_weapon_qty").value}' hx-target="body" hx-swap="innerHTML" class="btn btn-small">Buy</button>
                        <button hx-post="/game/trade/sell-weapons" hx-vals='js:{quantity: document.getElementById("trade_weapon_qty").value}' hx-target="body" hx-swap="innerHTML" class="btn btn-small">Sell</button>
                    </div>
                </div>
                {% else %}
                <div class="trade-inline-section trade-locked">
                    <h4><img src="/static/images/deg_weapons.png" alt="Weapons" style="height: 1em; vertical-align: middle;"> Weapons</h4>
                    <p class="hint">Need 10+ markets</p>
                </div>
                {% endif %}
                {% endif %}
            </div>

        </div>

        <!-- Advancement Requirements -->
        <div class="advancement-panel">
            <h3><img src="/static/images/deg_castle5.png" alt="Advancement" style="height: 1em; vertical-align: middle;"> Advancement to {{ state.get_next_grade_title() }}</h3>
            {% if state.grade < 5 %}
            <div class="requirements-list">
                {% for req in state.get_grade_requirements() %}
                {% if req.2 > req.1 %}
                <div class="requirement-item">
                    <span class="req-name">{{ req.0 }}</span>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <p class="max-rank">You have achieved the highest rank!</p>
            {% endif %}
        </div>
    </div>

    <!-- Fixed Footer with Finish Round Button -->
    <div class="game-footer-fixed">
        <button hx-post="/game/finish-round" hx-target="body" hx-swap="innerHTML" class="btn btn-large btn-finish-round">
            ⏭️ Finish Round &amp; Continue
        </button>
    </div>
</div>
{% endblock %}