{% extends "base.html" %}

{% block title %}{{ state.user_name }} - {{ state.get_grade_title() }} - Year {{ state.year }}{% endblock %}

{% block content %}
<div class="game-view">
    <!-- Header with player info -->
    <div class="game-header">
        <div class="player-info">
            <h1>{{ state.get_grade_title() }} {{ state.user_name }}</h1>
            <p class="year">Year {{ state.year }} | Round {{ state.round }}</p>
        </div>
    </div>

    <!-- Resources Bar -->
    <div class="resources-bar">
        <div class="resource-item">
            <span class="resource-icon">💰</span>
            <span class="resource-label">Gold:</span>
            <span class="resource-value">{{ state.gold }}</span>
        </div>
        <div class="resource-item">
            <span class="resource-icon">🌾</span>
            <span class="resource-label">Food:</span>
            <span class="resource-value">{{ state.food_quantity }}</span>
        </div>
        <div class="resource-item">
            <span class="resource-icon">👥</span>
            <span class="resource-label">Citizens:</span>
            <span class="resource-value">{{ state.man_quantity }}</span>
        </div>
        <div class="resource-item">
            <span class="resource-icon">⚔️</span>
            <span class="resource-label">Soldiers:</span>
            <span class="resource-value">{{ state.soldier_quantity }}</span>
        </div>
        <div class="resource-item">
            <span class="resource-icon">❤️</span>
            <span class="resource-label">Popularity:</span>
            <span class="resource-value">{{ state.popularity_percent }}%</span>
        </div>
    </div>

    <!-- Main Game Area -->
    <div class="game-content">
        <!-- Kingdom Visual Representation -->
        <div class="kingdom-section">
            <h3 style="text-align: center; color: var(--primary-color); margin-bottom: 10px;">🏰 Your Kingdom</h3>
            <div class="kingdom-canvas">
                <!-- Background Land -->
                <img src="/static/images/deg_land.png" alt="Land" class="kingdom-land pixel-art" />

                <!-- Castle Structures - positioned based on level -->
                {% if state.castle_level == 0 %}
                <img src="/static/images/deg_castle0.png" alt="Castle Level 0" class="kingdom-castle castle-main pixel-art" />
                {% endif %}
                {% if state.castle_level > 0 %}
                {% if state.castle_level < 5 %}
                <img src="/static/images/deg_castle1.png" alt="Castle Level 1-4" class="kingdom-castle castle-main pixel-art" />
                {% endif %}
                {% endif %}
                {% if state.castle_level > 1 %}
                <img src="/static/images/deg_castle2.png" alt="Castle Tower 1" class="kingdom-castle castle-left-tower pixel-art" />
                {% endif %}
                {% if state.castle_level > 2 %}
                <img src="/static/images/deg_castle3.png" alt="Castle Wing" class="kingdom-castle castle-left-wing pixel-art" />
                {% endif %}
                {% if state.castle_level > 3 %}
                <img src="/static/images/deg_castle4.png" alt="Castle Level 4+" class="kingdom-castle castle-main-upgrade pixel-art" />
                {% endif %}
                {% if state.castle_level > 4 %}
                <img src="/static/images/deg_castle3.png" alt="Castle Right Wing" class="kingdom-castle castle-right-wing pixel-art" />
                {% endif %}
                {% if state.castle_level > 5 %}
                <img src="/static/images/deg_castle2.png" alt="Castle Right Tower" class="kingdom-castle castle-right-tower pixel-art" />
                {% endif %}
                {% if state.castle_level > 6 %}
                <img src="/static/images/deg_castle5.png" alt="Castle Spire Left" class="kingdom-castle castle-spire-left pixel-art" />
                {% endif %}
                {% if state.castle_level > 7 %}
                <img src="/static/images/deg_castle5.png" alt="Castle Spire Right" class="kingdom-castle castle-spire-right pixel-art" />
                {% endif %}

                <!-- Farms - positioned based on quantity -->
                {% if state.farm_quantity > 0 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-1 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 19 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-2 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 29 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-3 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 39 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-4 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 49 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-5 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 99 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-6 pixel-art" />
                {% endif %}

                <!-- Markets - positioned based on quantity -->
                {% if state.market_quantity > 0 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-1 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 4 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-2 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 9 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-3 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 39 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-4 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 49 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-5 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 99 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-6 pixel-art" />
                {% endif %}

                <!-- Mines - positioned based on quantity -->
                {% if state.mine_quantity > 0 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-1 pixel-art" />
                {% endif %}
                {% if state.mine_quantity > 19 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-2 pixel-art" />
                {% endif %}
                {% if state.mine_quantity > 29 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-3 pixel-art" />
                {% endif %}

                <!-- Smithies - positioned based on quantity -->
                {% if state.smithy_quantity > 0 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-1 pixel-art" />
                {% endif %}
                {% if state.smithy_quantity > 19 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-2 pixel-art" />
                {% endif %}
                {% if state.smithy_quantity > 29 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-3 pixel-art" />
                {% endif %}
            </div>

            <!-- Castle Info and Upgrade -->
            <div class="castle-info">
                <h3>🏰 Castle Level {{ state.castle_level }}</h3>
                {% if state.castle_level < 8 %}
                <button
                    hx-post="/game/upgrade-castle"
                    hx-target="body"
                    hx-swap="innerHTML"
                    class="btn btn-upgrade"
                    {% if !state.can_upgrade_castle() %}disabled{% endif %}>
                    ⬆️ Upgrade ({{ state.price_for_castle }} gold)
                </button>
                {% else %}
                <p class="max-level">Maximum Level Reached!</p>
                {% endif %}
            </div>
        </div>

        <!-- Action Panels -->
        <div class="action-panels">
            <!-- Settings Panel -->
            <div class="panel">
                <h3>⚙️ Settings</h3>
                <div class="setting-item">
                    <label>Taxes:</label>
                    <select name="taxes_level" hx-post="/game/set-taxes" hx-target="body" hx-swap="innerHTML" class="setting-select">
                        <option value="0" {% if state.taxes_level == 0 %}selected{% endif %}>None</option>
                        <option value="1" {% if state.taxes_level == 1 %}selected{% endif %}>Very Low</option>
                        <option value="2" {% if state.taxes_level == 2 %}selected{% endif %}>Low</option>
                        <option value="3" {% if state.taxes_level == 3 %}selected{% endif %}>Medium</option>
                        <option value="4" {% if state.taxes_level == 4 %}selected{% endif %}>High</option>
                        <option value="5" {% if state.taxes_level == 5 %}selected{% endif %}>Very High</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Food Rations:</label>
                    <select name="food_supply" hx-post="/game/set-food-supply" hx-target="body" hx-swap="innerHTML" class="setting-select">
                        <option value="0" {% if state.food_supply == 0 %}selected{% endif %}>None</option>
                        <option value="1" {% if state.food_supply == 1 %}selected{% endif %}>Very Low</option>
                        <option value="2" {% if state.food_supply == 2 %}selected{% endif %}>Low</option>
                        <option value="3" {% if state.food_supply == 3 %}selected{% endif %}>Medium</option>
                        <option value="4" {% if state.food_supply == 4 %}selected{% endif %}>High</option>
                        <option value="5" {% if state.food_supply == 5 %}selected{% endif %}>Very High</option>
                    </select>
                </div>
            </div>

            <!-- Buildings Panel -->
            <div class="panel">
                <h3>🏗️ Buildings</h3>
                <div class="building-list">
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon">🌾</span>
                            <span>Farms: {{ state.farm_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-farm" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_farm() %}disabled{% endif %}>
                            Build ({{ state.price_for_farm }} 💰)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon">⛏️</span>
                            <span>Mines: {{ state.mine_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-mine" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_mine() %}disabled{% endif %}>
                            Build ({{ state.price_for_mine }} 💰)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon">🔨</span>
                            <span>Smithies: {{ state.smithy_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-smithy" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_smithy() %}disabled{% endif %}>
                            Build ({{ state.price_for_smithy }} 💰)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon">🏪</span>
                            <span>Markets: {{ state.market_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-market" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_market() %}disabled{% endif %}>
                            Build ({{ state.price_for_market }} 💰)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Military Panel -->
            <div class="panel">
                <h3>⚔️ Military</h3>
                <div class="military-info">
                    <p>Soldiers: {{ state.soldier_quantity }}</p>
                    <p>Weapons: {{ state.weapon_quantity }}</p>
                    <p>Iron: {{ state.iron_quantity }}</p>
                </div>
                <a href="/game/army" class="btn btn-small" style="display: inline-block; margin: 10px 0;">🎖️ Manage Army</a>
                <div class="army-preview" style="margin-top: 10px;">
                    <p class="hint">Recruit citizens into soldiers to protect your realm.</p>
                    {% if state.weapon_quantity > 0 && state.man_quantity > 200 %}
                    <p style="color: #27ae60; font-size: 0.9em;">✅ Ready to recruit!</p>
                    {% else %}
                    <p style="color: #e74c3c; font-size: 0.9em;">⚠️ Need weapons and citizens</p>
                    {% endif %}
                </div>            </div>

            <!-- Trade Panel -->
            <div class="panel">
                <h3>💱 Trade</h3>
                <p>Market Places: {{ state.market_quantity }}</p>
                {% if state.market_quantity > 0 %}
                <a href="/game/trade" class="btn btn-small" style="display: inline-block; margin: 10px 0;">🏪 Open Market</a>
                <div class="trade-preview" style="margin-top: 10px;">
                    <p class="hint">Available trades:</p>
                    <ul style="margin: 5px 0; padding-left: 20px; font-size: 0.9em;">
                        <li>🌾 Food (always available)</li>
                        {% if state.market_quantity > 4 %}
                        <li>⚙️ Iron (unlocked)</li>
                        {% else %}
                        <li style="opacity: 0.5;">🔒 Iron (need 5+ markets)</li>
                        {% endif %}
                        {% if state.market_quantity > 9 %}
                        <li>⚔️ Weapons (unlocked)</li>
                        {% else %}
                        <li style="opacity: 0.5;">🔒 Weapons (need 10+ markets)</li>
                        {% endif %}
                    </ul>
                </div>
                {% else %}
                <p class="hint">Build a market to trade!</p>
                {% endif %}
            </div>

        </div>

        <!-- Advancement Requirements -->
        <div class="advancement-panel">
            <h3>📊 Advancement to {{ state.get_next_grade_title() }}</h3>
            {% if state.grade < 5 %}
            <div class="requirements-list">
                {% for req in state.get_grade_requirements() %}
                {% if req.2 > req.1 %}
                <div class="requirement-item">
                    <span class="req-name">{{ req.0 }}</span>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <p class="max-rank">You have achieved the highest rank!</p>
            {% endif %}
        </div>

        <!-- Finish Round Button -->
        <div class="round-actions">
            <button hx-post="/game/finish-round" hx-target="body" hx-swap="innerHTML" class="btn btn-large btn-finish-round">
                ⏭️ Finish Round &amp; Continue
            </button>
        </div>
    </div>
</div>
{% endblock %}