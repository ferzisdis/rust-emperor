{% extends "base.html" %}

{% block title %}{{ state.user_name }} - {{ state.get_grade_title() }} - Year {{ state.year }}{% endblock %}

{% block content %}
<div class="game-view">
    <!-- Combined Header with Resources -->
    <div class="game-header-combined">
        <div class="player-info-inline">
            <span class="player-title">{{ state.get_grade_title() }} {{ state.user_name }}</span>
            <span class="player-meta">(Year {{ state.year }} / Round {{ state.round }})</span>
        </div>
        <div class="resources-inline">
            <div class="resource-inline">
                <span class="resource-icon"><img src="/static/images/deg_gold.png" alt="Gold" style="height: 1em; vertical-align: middle;"></span>
                <span class="resource-label">Gold</span>
                <span class="resource-value">{{ state.gold }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon"><img src="/static/images/deg_food.png" alt="Food" style="height: 1em; vertical-align: middle;"></span>
                <span class="resource-label">Food</span>
                <span class="resource-value">{{ state.food_quantity }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon"><img src="/static/images/deg_man.png" alt="Citizens" style="height: 1em; vertical-align: middle;"></span>
                <span class="resource-label">Citizen</span>
                <span class="resource-value">{{ state.man_quantity }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon"><img src="/static/images/deg_iron.png" alt="Iron" style="height: 1em; vertical-align: middle;"></span>
                <span class="resource-label">Iron</span>
                <span class="resource-value">{{ state.iron_quantity }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon"><img src="/static/images/deg_weapons.png" alt="Weapon" style="height: 1em; vertical-align: middle;"></span>
                <span class="resource-label">Weapon</span>
                <span class="resource-value">{{ state.weapon_quantity }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon"><img src="/static/images/deg_soldier.png" alt="Army" style="height: 1em; vertical-align: middle;"></span>
                <span class="resource-label">Army</span>
                <span class="resource-value">{{ state.soldier_quantity }}</span>
            </div>
            <span class="resource-divider">|</span>
            <div class="resource-inline">
                <span class="resource-icon">‚ô•</span>
                <span class="resource-label">Popularity</span>
                <span class="resource-value">{{ state.popularity_percent }}%</span>
            </div>
        </div>
    </div>

    <!-- Main Game Area -->
    <div class="game-content">
        <!-- Kingdom Visual Representation -->
        <div class="kingdom-section">
            <h3 class="title-decorative"><img src="/static/images/deg_castle1.png" alt="Castle" style="height: 1em; vertical-align: middle;"> Your Kingdom</h3>
            <div class="kingdom-canvas">
                <!-- Background Land -->
                <img src="/static/images/deg_land.png" alt="Land" class="kingdom-land pixel-art" />

                <!-- Castle Structures - positioned based on level -->
                {% if state.castle_level == 0 %}
                <img src="/static/images/deg_castle0.png" alt="Castle Level 0" class="kingdom-castle castle-main pixel-art" />
                {% endif %}
                {% if state.castle_level > 0 %}
                {% if state.castle_level < 5 %}
                <img src="/static/images/deg_castle1.png" alt="Castle Level 1-4" class="kingdom-castle castle-main pixel-art" />
                {% endif %}
                {% endif %}
                {% if state.castle_level > 1 %}
                <img src="/static/images/deg_castle2.png" alt="Castle Tower 1" class="kingdom-castle castle-left-tower pixel-art" />
                {% endif %}
                {% if state.castle_level > 2 %}
                <img src="/static/images/deg_castle3.png" alt="Castle Wing" class="kingdom-castle castle-left-wing pixel-art" />
                {% endif %}
                {% if state.castle_level > 3 %}
                <img src="/static/images/deg_castle4.png" alt="Castle Level 4+" class="kingdom-castle castle-main-upgrade pixel-art" />
                {% endif %}
                {% if state.castle_level > 4 %}
                <img src="/static/images/deg_castle3.png" alt="Castle Right Wing" class="kingdom-castle castle-right-wing pixel-art" />
                {% endif %}
                {% if state.castle_level > 5 %}
                <img src="/static/images/deg_castle2.png" alt="Castle Right Tower" class="kingdom-castle castle-right-tower pixel-art" />
                {% endif %}
                {% if state.castle_level > 6 %}
                <img src="/static/images/deg_castle5.png" alt="Castle Spire Left" class="kingdom-castle castle-spire-left pixel-art" />
                {% endif %}
                {% if state.castle_level > 7 %}
                <img src="/static/images/deg_castle5.png" alt="Castle Spire Right" class="kingdom-castle castle-spire-right pixel-art" />
                {% endif %}

                <!-- Farms - positioned based on quantity -->
                {% if state.farm_quantity > 0 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-1 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 19 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-2 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 29 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-3 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 39 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-4 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 49 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-5 pixel-art" />
                {% endif %}
                {% if state.farm_quantity > 99 %}
                <img src="/static/images/deg_farm.png" alt="Farm" class="kingdom-building farm-6 pixel-art" />
                {% endif %}

                <!-- Markets - positioned based on quantity -->
                {% if state.market_quantity > 0 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-1 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 4 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-2 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 9 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-3 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 39 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-4 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 49 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-5 pixel-art" />
                {% endif %}
                {% if state.market_quantity > 99 %}
                <img src="/static/images/deg_market.png" alt="Market" class="kingdom-building market-6 pixel-art" />
                {% endif %}

                <!-- Mines - positioned based on quantity -->
                {% if state.mine_quantity > 0 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-1 pixel-art" />
                {% endif %}
                {% if state.mine_quantity > 19 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-2 pixel-art" />
                {% endif %}
                {% if state.mine_quantity > 29 %}
                <img src="/static/images/deg_mine.png" alt="Mine" class="kingdom-building mine-3 pixel-art" />
                {% endif %}

                <!-- Smithies - positioned based on quantity -->
                {% if state.smithy_quantity > 0 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-1 pixel-art" />
                {% endif %}
                {% if state.smithy_quantity > 19 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-2 pixel-art" />
                {% endif %}
                {% if state.smithy_quantity > 29 %}
                <img src="/static/images/deg_smithy.png" alt="Smithy" class="kingdom-building smithy-3 pixel-art" />
                {% endif %}
            </div>

        </div>

        <!-- Action Panels -->
        <div class="action-panels">
            <!-- Settings Panel -->
            <div class="panel">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="setting-item">
                    <label>Taxes:</label>
                    <select name="taxes_level" hx-post="/game/set-taxes" hx-target="body" hx-swap="innerHTML" class="setting-select">
                        <option value="0" {% if state.taxes_level == 0 %}selected{% endif %}>None (0 gold)</option>
                        <option value="1" {% if state.taxes_level == 1 %}selected{% endif %}>Very Low ({{ (state.man_quantity * 1 * 10 / 30) }} gold)</option>
                        <option value="2" {% if state.taxes_level == 2 %}selected{% endif %}>Low ({{ (state.man_quantity * 2 * 10 / 30) }} gold)</option>
                        <option value="3" {% if state.taxes_level == 3 %}selected{% endif %}>Medium ({{ (state.man_quantity * 3 * 10 / 30) }} gold)</option>
                        <option value="4" {% if state.taxes_level == 4 %}selected{% endif %}>High ({{ (state.man_quantity * 4 * 10 / 30) }} gold)</option>
                        <option value="5" {% if state.taxes_level == 5 %}selected{% endif %}>Very High ({{ (state.man_quantity * 5 * 10 / 30) }} gold)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Food Rations:</label>
                    <select name="food_supply" hx-post="/game/set-food-supply" hx-target="body" hx-swap="innerHTML" class="setting-select">
                        <option value="0" {% if state.food_supply == 0 %}selected{% endif %}>None (0 food)</option>
                        <option value="1" {% if state.food_supply == 1 %}selected{% endif %}>Very Low ({{ (state.man_quantity * (1 * 34 - 2) / 100) }} food)</option>
                        <option value="2" {% if state.food_supply == 2 %}selected{% endif %}>Low ({{ (state.man_quantity * (2 * 34 - 2) / 100) }} food)</option>
                        <option value="3" {% if state.food_supply == 3 %}selected{% endif %}>Medium ({{ (state.man_quantity * (3 * 34 - 2) / 100) }} food)</option>
                        <option value="4" {% if state.food_supply == 4 %}selected{% endif %}>High ({{ (state.man_quantity * (4 * 34 - 2) / 100) }} food)</option>
                        <option value="5" {% if state.food_supply == 5 %}selected{% endif %}>Very High ({{ (state.man_quantity * (5 * 34 - 2) / 100) }} food)</option>
                    </select>
                </div>
            </div>

            <!-- Buildings Panel -->
            <div class="panel">
                <h3><img src="/static/images/deg_castle1.png" alt="Buildings" style="height: 1em; vertical-align: middle;"> Buildings</h3>
                <div class="building-list">
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon"><img src="/static/images/deg_castle1.png" alt="Castle" style="height: 1em; vertical-align: middle;"></span>
                            <span>Castle: Level {{ state.castle_level }}</span>
                        </span>
                        {% if state.castle_level < 8 %}
                        <button hx-post="/game/upgrade-castle" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_upgrade_castle() %}disabled{% endif %}>
                            Upgrade ({{ state.price_for_castle }} <img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">)
                        </button>
                        {% else %}
                        <button class="btn btn-small" disabled>Max Level</button>
                        {% endif %}
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon"><img src="/static/images/deg_farm.png" alt="Farm" style="height: 1em; vertical-align: middle;"></span>
                            <span>Farms: {{ state.farm_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-farm" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_farm() %}disabled{% endif %}>
                            Build ({{ state.price_for_farm }} <img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon"><img src="/static/images/deg_mine.png" alt="Mine" style="height: 1em; vertical-align: middle;"></span>
                            <span>Mines: {{ state.mine_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-mine" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_mine() %}disabled{% endif %}>
                            Build ({{ state.price_for_mine }} <img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon"><img src="/static/images/deg_smithy.png" alt="Smithy" style="height: 1em; vertical-align: middle;"></span>
                            <span>Smithies: {{ state.smithy_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-smithy" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_smithy() %}disabled{% endif %}>
                            Build ({{ state.price_for_smithy }} <img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">)
                        </button>
                    </div>
                    <div class="building-item">
                        <span class="building-info">
                            <span class="building-icon"><img src="/static/images/deg_market.png" alt="Market" style="height: 1em; vertical-align: middle;"></span>
                            <span>Markets: {{ state.market_quantity }}</span>
                        </span>
                        <button hx-post="/game/build-market" hx-target="body" hx-swap="innerHTML" class="btn btn-small" {% if !state.can_build_market() %}disabled{% endif %}>
                            Build ({{ state.price_for_market }} <img src="/static/images/deg_gold.png" alt="Gold" style="height: 0.9em; vertical-align: middle;">)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Military Panel -->
            <div class="panel">
                <!-- Military Panel Header -->
                <div class="trade-header">
                    <div class="trade-header-left">
                        <img src="/static/images/deg_soldier.png" alt="Military" style="height: 1.2em; vertical-align: middle;">
                        <h3>Military</h3>
                        <span class="trade-market-count">‚Ä¢ {{ state.soldier_quantity }} soldier(s)</span>
                    </div>
                    <div class="trade-balance" id="military-balance">
                        {{ state.gold }}<img src="/static/images/deg_gold.png" alt="Gold">
                    </div>
                </div>

                <!-- Military Actions List -->
                <div class="trade-goods-list">
                    <!-- Recruit Soldiers -->
                    <div class="trade-good-item">
                        <div class="trade-good-info">
                            <div class="trade-good-icon">
                                <img src="/static/images/deg_soldier.png" alt="Recruit">
                            </div>
                            <span class="trade-good-name">Recruit Soldiers</span>
                            <div class="trade-good-details">
                                {{ state.soldier_price }}<img src="/static/images/deg_gold.png" alt="Gold">/unit ‚Ä¢ Citizens: {{ state.man_quantity }} ‚Ä¢ Weapons: {{ state.weapon_quantity }}
                            </div>
                        </div>
                        <div class="trade-good-controls">
                            <div class="trade-input-section">
                                <input type="number" id="recruit_qty" name="quantity" value="1" min="0" step="1">
                                <div class="trade-quick-buttons">
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('recruit_qty'); input.value = 1; input.dispatchEvent(new Event('input'));">1</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('recruit_qty'); input.value = 10; input.dispatchEvent(new Event('input'));">10</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('recruit_qty'); input.value = 50; input.dispatchEvent(new Event('input'));">50</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('recruit_qty'); input.value = 100; input.dispatchEvent(new Event('input'));">100</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('recruit_qty'); input.value = Math.min(Math.floor({{ state.gold }} / {{ state.soldier_price }}), {{ state.weapon_quantity }}, Math.max(0, {{ state.man_quantity }} - 200)); input.dispatchEvent(new Event('input'));">MAX</button>
                                </div>
                            </div>
                            <div class="trade-action-buttons">
                                <button 
                                    hx-post="/game/army/recruit" 
                                    hx-vals='js:{quantity: document.getElementById("recruit_qty").value}' 
                                    hx-target="body" 
                                    hx-swap="innerHTML"
                                    hx-disabled-elt="this"
                                    class="btn btn-trade-buy"
                                    id="recruit_soldier_btn"
                                    {% if state.man_quantity <= 200 || state.weapon_quantity == 0 || !state.can_afford_soldier() %}disabled{% endif %}>
                                    Recruit
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Discharge Soldiers -->
                    <div class="trade-good-item">
                        <div class="trade-good-info">
                            <div class="trade-good-icon">
                                <img src="/static/images/deg_man.png" alt="Discharge">
                            </div>
                            <span class="trade-good-name">Discharge Soldiers</span>
                            <div class="trade-good-details">
                                Returns soldiers to citizens ‚Ä¢ Current: {{ state.soldier_quantity }}
                            </div>
                        </div>
                        <div class="trade-good-controls">
                            <div class="trade-input-section">
                                <input type="number" id="discharge_qty" name="quantity" value="1" min="0" step="1">
                                <div class="trade-quick-buttons">
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('discharge_qty'); input.value = 1; input.dispatchEvent(new Event('input'));">1</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('discharge_qty'); input.value = 10; input.dispatchEvent(new Event('input'));">10</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('discharge_qty'); input.value = 50; input.dispatchEvent(new Event('input'));">50</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('discharge_qty'); input.value = 100; input.dispatchEvent(new Event('input'));">100</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('discharge_qty'); input.value = {{ state.soldier_quantity }}; input.dispatchEvent(new Event('input'));">MAX</button>
                                </div>
                            </div>
                            <div class="trade-action-buttons">
                                <button 
                                    hx-post="/game/army/discharge" 
                                    hx-vals='js:{quantity: document.getElementById("discharge_qty").value}' 
                                    hx-target="body" 
                                    hx-swap="innerHTML"
                                    hx-disabled-elt="this"
                                    class="btn btn-trade-sell"
                                    id="discharge_soldier_btn"
                                    {% if state.soldier_quantity == 0 %}disabled{% endif %}>
                                    Discharge
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade Panel -->
            <div class="panel">
                {% if state.market_quantity == 0 %}
                <h3><img src="/static/images/deg_market.png" alt="Trade" style="height: 1em; vertical-align: middle;"> Trade</h3>
                <p class="hint">Build a market to trade!</p>
                {% else %}
                <!-- Trade Panel Header -->
                <div class="trade-header">
                    <div class="trade-header-left">
                        <img src="/static/images/deg_market.png" alt="Trade" style="height: 1.2em; vertical-align: middle;">
                        <h3>Trade</h3>
                        <span class="trade-market-count">‚Ä¢ {{ state.market_quantity }} market(s)</span>
                    </div>
                    <div class="trade-balance" id="player-balance">
                        {{ state.gold }}<img src="/static/images/deg_gold.png" alt="Gold">
                    </div>
                </div>

                <!-- Trade Goods List -->
                <div class="trade-goods-list">
                    <!-- Food Trading -->
                    <div class="trade-good-item">
                        <div class="trade-good-info">
                            <div class="trade-good-icon">
                                <img src="/static/images/deg_food.png" alt="Food">
                            </div>
                            <span class="trade-good-name">Food</span>
                            <div class="trade-good-details">
                                {{ state.price_for_food }}<img src="/static/images/deg_gold.png" alt="Gold">/100 ‚Ä¢ In stock: {{ state.food_quantity }}
                            </div>
                        </div>
                        <div class="trade-good-controls">
                            <div class="trade-input-section">
                                <input type="number" id="trade_food_qty" name="quantity" value="100" min="0" step="100">
                                <div class="trade-quick-buttons">
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_food_qty'); input.value = 100; input.dispatchEvent(new Event('input'));">100</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_food_qty'); input.value = 1000; input.dispatchEvent(new Event('input'));">1K</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_food_qty'); input.value = 10000; input.dispatchEvent(new Event('input'));">10K</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_food_qty'); input.value = Math.floor({{ state.gold }} / {{ state.price_for_food }}) * 100; input.dispatchEvent(new Event('input'));">MAX BUY</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_food_qty'); input.value = {{ state.food_quantity }}; input.dispatchEvent(new Event('input'));">MAX SELL</button>
                                </div>
                            </div>
                            <div class="trade-action-buttons">
                                <button 
                                    hx-post="/game/trade/buy-food" 
                                    hx-vals='js:{quantity: document.getElementById("trade_food_qty").value}' 
                                    hx-target="body" 
                                    hx-swap="innerHTML"
                                    hx-disabled-elt="this"
                                    class="btn btn-trade-buy"
                                    id="buy_food_btn">
                                    Buy
                                </button>
                                <button 
                                    hx-post="/game/trade/sell-food" 
                                    hx-vals='js:{quantity: document.getElementById("trade_food_qty").value}' 
                                    hx-target="body" 
                                    hx-swap="innerHTML"
                                    hx-disabled-elt="this"
                                    class="btn btn-trade-sell"
                                    id="sell_food_btn">
                                    Sell
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Iron Trading -->
                    {% if state.market_quantity > 4 %}
                    <div class="trade-good-item">
                        <div class="trade-good-info">
                            <div class="trade-good-icon">
                                <img src="/static/images/deg_iron.png" alt="Iron">
                            </div>
                            <span class="trade-good-name">Iron</span>
                            <div class="trade-good-details">
                                {{ state.price_for_armor }}<img src="/static/images/deg_gold.png" alt="Gold">/unit ‚Ä¢ In stock: {{ state.iron_quantity }}/{{ state.trade_limit }}
                            </div>
                        </div>
                        <div class="trade-good-controls">
                            <div class="trade-input-section">
                                <input type="number" id="trade_iron_qty" name="quantity" value="1" min="0" step="1">
                                <div class="trade-quick-buttons">
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_iron_qty'); input.value = 1; input.dispatchEvent(new Event('input'));">1</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_iron_qty'); input.value = 10; input.dispatchEvent(new Event('input'));">10</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_iron_qty'); input.value = 100; input.dispatchEvent(new Event('input'));">100</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_iron_qty'); input.value = Math.floor({{ state.gold }} / {{ state.price_for_armor }}); input.dispatchEvent(new Event('input'));">MAX BUY</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_iron_qty'); input.value = {{ state.iron_quantity }}; input.dispatchEvent(new Event('input'));">MAX SELL</button>
                                </div>
                            </div>
                            <div class="trade-action-buttons">
                                <button 
                                    hx-post="/game/trade/buy-iron" 
                                    hx-vals='js:{quantity: document.getElementById("trade_iron_qty").value}' 
                                    hx-target="body" 
                                    hx-swap="innerHTML"
                                    hx-disabled-elt="this"
                                    class="btn btn-trade-buy"
                                    id="buy_iron_btn">
                                    Buy
                                </button>
                                <button 
                                    hx-post="/game/trade/sell-iron" 
                                    hx-vals='js:{quantity: document.getElementById("trade_iron_qty").value}' 
                                    hx-target="body" 
                                    hx-swap="innerHTML"
                                    hx-disabled-elt="this"
                                    class="btn btn-trade-sell"
                                    id="sell_iron_btn">
                                    Sell
                                </button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="trade-good-item trade-good-locked">
                        <div class="trade-good-info">
                            <div class="trade-good-icon">
                                <img src="/static/images/deg_iron.png" alt="Iron">
                            </div>
                            <span class="trade-good-name">Iron</span>
                            <span class="trade-good-lock">üîí</span>
                        </div>
                        <div class="trade-locked-text">Requires 5+ markets</div>
                    </div>
                    {% endif %}

                    <!-- Weapons Trading -->
                    {% if state.market_quantity > 9 %}
                    <div class="trade-good-item">
                        <div class="trade-good-info">
                            <div class="trade-good-icon">
                                <img src="/static/images/deg_weapons.png" alt="Weapons">
                            </div>
                            <span class="trade-good-name">Weapons</span>
                            <div class="trade-good-details">
                                {{ state.price_for_weapon }}<img src="/static/images/deg_gold.png" alt="Gold">/unit ‚Ä¢ In stock: {{ state.weapon_quantity }}/{{ state.trade_limit }}
                            </div>
                        </div>
                        <div class="trade-good-controls">
                            <div class="trade-input-section">
                                <input type="number" id="trade_weapon_qty" name="quantity" value="1" min="0" step="1">
                                <div class="trade-quick-buttons">
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_weapon_qty'); input.value = 1; input.dispatchEvent(new Event('input'));">1</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_weapon_qty'); input.value = 10; input.dispatchEvent(new Event('input'));">10</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_weapon_qty'); input.value = 100; input.dispatchEvent(new Event('input'));">100</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_weapon_qty'); input.value = Math.floor({{ state.gold }} / {{ state.price_for_weapon }}); input.dispatchEvent(new Event('input'));">MAX BUY</button>
                                    <button type="button" class="btn-quick-amount" onclick="let input = document.getElementById('trade_weapon_qty'); input.value = {{ state.weapon_quantity }}; input.dispatchEvent(new Event('input'));">MAX SELL</button>
                                </div>
                            </div>
                            <div class="trade-action-buttons">
                                <button 
                                    hx-post="/game/trade/buy-weapons" 
                                    hx-vals='js:{quantity: document.getElementById("trade_weapon_qty").value}' 
                                    hx-target="body" 
                                    hx-swap="innerHTML"
                                    hx-disabled-elt="this"
                                    class="btn btn-trade-buy"
                                    id="buy_weapon_btn">
                                    Buy
                                </button>
                                <button 
                                    hx-post="/game/trade/sell-weapons" 
                                    hx-vals='js:{quantity: document.getElementById("trade_weapon_qty").value}' 
                                    hx-target="body" 
                                    hx-swap="innerHTML"
                                    hx-disabled-elt="this"
                                    class="btn btn-trade-sell"
                                    id="sell_weapon_btn">
                                    Sell
                                </button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="trade-good-item trade-good-locked">
                        <div class="trade-good-info">
                            <div class="trade-good-icon">
                                <img src="/static/images/deg_weapons.png" alt="Weapons">
                            </div>
                            <span class="trade-good-name">Weapons</span>
                            <span class="trade-good-lock">üîí</span>
                        </div>
                        <div class="trade-locked-text">Requires 10+ markets</div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

        </div>

        <!-- Advancement Requirements -->
        <div class="advancement-panel">
            <h3><img src="/static/images/deg_castle5.png" alt="Advancement" style="height: 1em; vertical-align: middle;"> Advancement to {{ state.get_next_grade_title() }}</h3>
            {% if state.grade < 5 %}
            <div class="requirements-list">
                {% for req in state.get_grade_requirements() %}
                {% if req.2 > req.1 %}
                <div class="requirement-item">
                    <span class="req-name">{{ req.0 }}</span>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% else %}
            <p class="max-rank">You have achieved the highest rank!</p>
            {% endif %}
        </div>
    </div>

    <!-- Fixed Footer with Finish Round Button -->
    <div class="game-footer-fixed">
        <button hx-post="/game/finish-round" hx-target="body" hx-swap="innerHTML" class="btn btn-large btn-finish-round">
            ‚è≠Ô∏è Finish Round &amp; Continue
        </button>
    </div>
</div>

<script>
    // Dynamic cost preview for trade buttons
    (function() {
        const priceForFood = {{ state.price_for_food }};
        const priceForArmor = {{ state.price_for_armor }};
        const priceForWeapon = {{ state.price_for_weapon }};
        const currentGold = {{ state.gold }};
        const currentFood = {{ state.food_quantity }};
        const currentIron = {{ state.iron_quantity }};
        const currentWeapons = {{ state.weapon_quantity }};

        // Update food buttons
        const foodInput = document.getElementById('trade_food_qty');
        const buyFoodBtn = document.getElementById('buy_food_btn');
        const sellFoodBtn = document.getElementById('sell_food_btn');

        if (foodInput && buyFoodBtn && sellFoodBtn) {
            function updateFoodButtons() {
                const qty = parseInt(foodInput.value) || 0;
                const cost = Math.floor(qty / 100) * priceForFood;
                const income = Math.floor(qty / 100) * priceForFood;
                
                buyFoodBtn.textContent = `Buy (-${cost})`;
                sellFoodBtn.textContent = `Sell (+${income})`;
                
                // Disable if insufficient resources
                if (currentGold < cost) {
                    buyFoodBtn.classList.add('disabled');
                    buyFoodBtn.disabled = true;
                } else {
                    buyFoodBtn.classList.remove('disabled');
                    buyFoodBtn.disabled = false;
                }
                
                if (currentFood < qty) {
                    sellFoodBtn.classList.add('disabled');
                    sellFoodBtn.disabled = true;
                } else {
                    sellFoodBtn.classList.remove('disabled');
                    sellFoodBtn.disabled = false;
                }
            }
            
            foodInput.addEventListener('input', updateFoodButtons);
            foodInput.addEventListener('change', updateFoodButtons);
            updateFoodButtons();
        }

        // Update iron buttons
        const ironInput = document.getElementById('trade_iron_qty');
        const buyIronBtn = document.getElementById('buy_iron_btn');
        const sellIronBtn = document.getElementById('sell_iron_btn');

        if (ironInput && buyIronBtn && sellIronBtn) {
            function updateIronButtons() {
                const qty = parseInt(ironInput.value) || 0;
                const cost = qty * priceForArmor;
                const income = qty * priceForArmor;
                
                buyIronBtn.textContent = `Buy (-${cost})`;
                sellIronBtn.textContent = `Sell (+${income})`;
                
                if (currentGold < cost) {
                    buyIronBtn.classList.add('disabled');
                    buyIronBtn.disabled = true;
                } else {
                    buyIronBtn.classList.remove('disabled');
                    buyIronBtn.disabled = false;
                }
                
                if (currentIron < qty) {
                    sellIronBtn.classList.add('disabled');
                    sellIronBtn.disabled = true;
                } else {
                    sellIronBtn.classList.remove('disabled');
                    sellIronBtn.disabled = false;
                }
            }
            
            ironInput.addEventListener('input', updateIronButtons);
            ironInput.addEventListener('change', updateIronButtons);
            updateIronButtons();
        }

        // Update weapon buttons
        const weaponInput = document.getElementById('trade_weapon_qty');
        const buyWeaponBtn = document.getElementById('buy_weapon_btn');
        const sellWeaponBtn = document.getElementById('sell_weapon_btn');

        if (weaponInput && buyWeaponBtn && sellWeaponBtn) {
            function updateWeaponButtons() {
                const qty = parseInt(weaponInput.value) || 0;
                const cost = qty * priceForWeapon;
                const income = qty * priceForWeapon;
                
                buyWeaponBtn.textContent = `Buy (-${cost})`;
                sellWeaponBtn.textContent = `Sell (+${income})`;
                
                if (currentGold < cost) {
                    buyWeaponBtn.classList.add('disabled');
                    buyWeaponBtn.disabled = true;
                } else {
                    buyWeaponBtn.classList.remove('disabled');
                    buyWeaponBtn.disabled = false;
                }
                
                if (currentWeapons < qty) {
                    sellWeaponBtn.classList.add('disabled');
                    sellWeaponBtn.disabled = true;
                } else {
                    sellWeaponBtn.classList.remove('disabled');
                    sellWeaponBtn.disabled = false;
                }
            }
            
            weaponInput.addEventListener('input', updateWeaponButtons);
            weaponInput.addEventListener('change', updateWeaponButtons);
            updateWeaponButtons();
        }

        // Update military recruit buttons
        const recruitInput = document.getElementById('recruit_qty');
        const recruitBtn = document.getElementById('recruit_soldier_btn');
        const soldierPrice = {{ state.soldier_price }};
        const currentCitizens = {{ state.man_quantity }};
        const currentWeaponsForRecruit = {{ state.weapon_quantity }};

        if (recruitInput && recruitBtn) {
            function updateRecruitButtons() {
                const qty = parseInt(recruitInput.value) || 0;
                const cost = qty * soldierPrice;
                
                recruitBtn.textContent = `Recruit (-${cost})`;
                
                // Check all requirements: gold, weapons, and citizens (must keep 200)
                const maxAffordable = Math.floor(currentGold / soldierPrice);
                const availableCitizens = Math.max(0, currentCitizens - 200);
                const canRecruit = qty <= maxAffordable && qty <= currentWeaponsForRecruit && qty <= availableCitizens;
                
                if (!canRecruit || currentCitizens <= 200 || currentWeaponsForRecruit === 0) {
                    recruitBtn.classList.add('disabled');
                    recruitBtn.disabled = true;
                } else {
                    recruitBtn.classList.remove('disabled');
                    recruitBtn.disabled = false;
                }
            }
            
            recruitInput.addEventListener('input', updateRecruitButtons);
            recruitInput.addEventListener('change', updateRecruitButtons);
            updateRecruitButtons();
        }

        // Update military discharge buttons
        const dischargeInput = document.getElementById('discharge_qty');
        const dischargeBtn = document.getElementById('discharge_soldier_btn');
        const currentSoldiers = {{ state.soldier_quantity }};

        if (dischargeInput && dischargeBtn) {
            function updateDischargeButtons() {
                const qty = parseInt(dischargeInput.value) || 0;
                
                dischargeBtn.textContent = `Discharge (${qty})`;
                
                if (currentSoldiers < qty || currentSoldiers === 0) {
                    dischargeBtn.classList.add('disabled');
                    dischargeBtn.disabled = true;
                } else {
                    dischargeBtn.classList.remove('disabled');
                    dischargeBtn.disabled = false;
                }
            }
            
            dischargeInput.addEventListener('input', updateDischargeButtons);
            dischargeInput.addEventListener('change', updateDischargeButtons);
            updateDischargeButtons();
        }
    })();
</script>
{% endblock %}